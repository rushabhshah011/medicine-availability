name: Deploy Python Web App to Azure

# This workflow deploys a simple Python HTTP server for the static files
# NOTE: Azure Static Web Apps (see azure-static-webapps.yml) is recommended for static sites
# This Python option is only if you specifically need a Python backend

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: medfinder-india  # Set this to your Azure Web App name
  PYTHON_VERSION: '3.11'

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python version
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Create virtual environment and install dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          # No dependencies needed for static server, but add any if needed
          pip install gunicorn

      - name: Create Python server script
        run: |
          cat > server.py << 'EOF'
          #!/usr/bin/env python3
          """
          Simple HTTP server for MedFinder India static files
          """
          import http.server
          import socketserver
          import os
          from functools import partial

          PORT = int(os.environ.get('PORT', 8000))
          DIRECTORY = "."

          class MyHTTPRequestHandler(http.server.SimpleHTTPRequestHandler):
              def __init__(self, *args, **kwargs):
                  super().__init__(*args, directory=DIRECTORY, **kwargs)

              def end_headers(self):
                  # Add security headers
                  self.send_header('X-Content-Type-Options', 'nosniff')
                  self.send_header('X-Frame-Options', 'DENY')
                  self.send_header('X-XSS-Protection', '1; mode=block')
                  super().end_headers()

          if __name__ == '__main__':
              with socketserver.TCPServer(("", PORT), MyHTTPRequestHandler) as httpd:
                  print(f"Server running at http://localhost:{PORT}/")
                  httpd.serve_forever()
          EOF

      - name: Create startup script
        run: |
          cat > startup.sh << 'EOF'
          #!/bin/bash
          gunicorn --bind=0.0.0.0:8000 --timeout 600 --workers 2 --worker-class sync server:application || python server.py
          EOF
          chmod +x startup.sh

      - name: Zip artifact for deployment
        run: zip -r release.zip . -x "*.git*" -x "venv/*"

      - name: Upload artifact for deployment
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: release.zip

  deploy:
    permissions:
      contents: none
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: 'production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: python-app

      - name: Unzip artifact for deployment
        run: unzip release.zip

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          # Uncomment below to use service principal instead
          # slot-name: 'production'
          # credentials: ${{ secrets.AZURE_CREDENTIALS }}
